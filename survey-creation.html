<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Survey Creation â€“ SmartSurvey</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/lucide@latest/dist/umd/lucide.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Cohere API will be called directly via fetch -->
  <style>
    body { font-family: 'Inter', sans-serif; }
    .blob {
      position: absolute; border-radius: 100%; filter: blur(18px); opacity: .23; z-index: 0;
      animation: float 10s ease-in-out infinite alternate;
    }
    @keyframes float {
      to { transform: translateY(-40px) scale(1.05);}
    }
    .gradient-border {
      border: 2px solid transparent;
      border-radius: 1.25rem;
      background-clip: padding-box, border-box;
      background-origin: border-box;
      background-image: linear-gradient(white, white), linear-gradient(110deg, #a0e9ff 0%, #b5ead7 70%, #e0c3fc 100%);
    }
    @keyframes blob1 {
      0%,100% { transform: translateY(0) scale(1);}
      50% { transform: translateY(-30px) scale(1.07);}
    }
    @keyframes blob2 {
      0%,100% { transform: translateX(0) scale(1);}
      50% { transform: translateX(40px) scale(1.1);}
    }
    @keyframes blob3 {
      0%,100% { transform: translate(-50%,0) scale(1);}
      50% { transform: translate(-50%,30px) scale(1.05);}
    }
    .animate-blob1 { animation: blob1 12s ease-in-out infinite; }
    .animate-blob2 { animation: blob2 14s ease-in-out infinite; }
    .animate-blob3 { animation: blob3 16s ease-in-out infinite; }

    @keyframes float-dot1 {
      0%,100% { transform: translateY(0) scale(1);}
      50% { transform: translateY(-18px) scale(1.08);}
    }
    @keyframes float-dot2 {
      0%,100% { transform: translateY(0) scale(1);}
      50% { transform: translateY(14px) scale(0.96);}
    }
    .animate-float-dot1 { animation: float-dot1 9s ease-in-out infinite; }
    .animate-float-dot2 { animation: float-dot2 11s ease-in-out infinite; }

    /* Professional polish */
    .sidebar-pro {
      background: linear-gradient(120deg, #f0f9ff 60%, #f3e8ff 100%);
      box-shadow: 0 4px 32px 0 rgba(80,120,255,0.07), 0 1.5px 6px 0 rgba(80,120,255,0.04);
      border: 1.5px solid #e0e7ff;
    }
    .sidebar-pro .active {
      background: linear-gradient(90deg, #38bdf8 0%, #818cf8 100%);
      color: #fff !important;
      box-shadow: 0 2px 8px 0 rgba(56,189,248,0.08);
    }
    .survey-card-pro {
      border-radius: 1.5rem;
      box-shadow: 0 4px 32px 0 rgba(80,120,255,0.07), 0 1.5px 6px 0 rgba(80,120,255,0.04);
      border: 1.5px solid #e0e7ff;
      background: linear-gradient(120deg, #fff 80%, #f0f9ff 100%);
      transition: box-shadow 0.2s;
    }
    .survey-card-pro:focus-within, .survey-card-pro:hover {
      box-shadow: 0 8px 32px 0 rgba(56,189,248,0.13), 0 2px 8px 0 rgba(80,120,255,0.07);
      border-color: #a5b4fc;
    }
    .question-card-pro {
      border-radius: 1.25rem;
      border: 1.5px solid #e0e7ff;
      background: linear-gradient(120deg, #fff 80%, #f0f9ff 100%);
      box-shadow: 0 2px 12px 0 rgba(56,189,248,0.06);
      transition: box-shadow 0.2s, border-color 0.2s;
    }
    .question-card-pro:focus-within, .question-card-pro:hover {
      box-shadow: 0 8px 32px 0 rgba(56,189,248,0.13), 0 2px 8px 0 rgba(80,120,255,0.07);
      border-color: #818cf8;
    }
    .option-input:focus {
      background: #f0f9ff;
      border-radius: 0.375rem;
    }
    .questionText:focus {
      background: #f0f9ff;
      border-radius: 0.375rem;
    }
    .addOptionBtn, .remove-option {
      transition: color 0.15s;
    }
    .addOptionBtn:focus, .remove-option:focus {
      outline: 2px solid #38bdf8;
    }
    .delete-question:focus {
      outline: 2px solid #ef4444;
    }
    .logicBtn:focus {
      outline: 2px solid #818cf8;
    }
    .survey-btn-pro {
      box-shadow: 0 2px 8px 0 rgba(56,189,248,0.07);
      font-weight: 600;
      letter-spacing: 0.01em;
    }
    .survey-btn-pro:focus {
      outline: 2px solid #818cf8;
    }
    /* Responsive tweaks */
    @media (max-width: 900px) {
      .sidebar-pro { max-width: 100%; margin-bottom: 2rem;}
      .survey-card-pro, .question-card-pro { margin-left: 0; margin-right: 0;}
    }
    .question-card-pro table.likert-table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      background: transparent;
      margin-top: 0.5rem;
      margin-bottom: 0.5rem;
    }
    .question-card-pro table.likert-table th,
    .question-card-pro table.likert-table td {
      padding: 0.5rem 0.75rem;
      text-align: center;
    }
    .question-card-pro table.likert-table th {
      color: #6366f1;
      font-weight: 500;
      font-size: 0.95rem;
      background: #f0f9ff;
      border-bottom: 1.5px solid #e0e7ff;
    }
    .question-card-pro table.likert-table td:first-child {
      text-align: left;
      color: #334155;
      background: #f8fafc;
      font-weight: 500;
      border-right: 1.5px solid #e0e7ff;
    }
    .question-card-pro table.likert-table tr {
      transition: background 0.15s;
    }
    .question-card-pro table.likert-table tr:hover {
      background: #f3f4f6;
    }
    .question-card-pro table.likert-table input[type="radio"] {
      accent-color: #6366f1;
      width: 1.1rem;
      height: 1.1rem;
      cursor: pointer;
    }
    
    /* AI Chatbot Styles */
    .ai-chatbot {
      position: fixed;
      bottom: 2rem;
      right: 2rem;
      z-index: 50;
    }
    
    .ai-chatbot-btn {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      background: linear-gradient(135deg, #6366f1, #8b5cf6);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      box-shadow: 0 10px 25px -5px rgba(99, 102, 241, 0.3), 0 8px 10px -6px rgba(99, 102, 241, 0.2);
      transition: all 0.3s ease;
      border: none;
      outline: none;
    }
    
    .ai-chatbot-btn:hover {
      transform: translateY(-3px);
      box-shadow: 0 20px 25px -5px rgba(99, 102, 241, 0.3), 0 10px 10px -6px rgba(99, 102, 241, 0.2);
    }
    
    .ai-chatbot-panel {
      position: fixed;
      bottom: 5.5rem;
      right: 2rem;
      width: 380px;
      max-width: 90vw;
      height: 600px;
      max-height: 80vh;
      background: white;
      border-radius: 1rem;
      box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1);
      display: flex;
      flex-direction: column;
      overflow: hidden;
      transform: translateY(20px);
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
      z-index: 40;
    }
    
    .ai-chatbot-panel.active {
      transform: translateY(0);
      opacity: 1;
      visibility: visible;
    }
    
    .ai-chatbot-header {
      background: linear-gradient(135deg, #6366f1, #8b5cf6);
      color: white;
      padding: 1rem 1.25rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    
    .ai-chatbot-header h3 {
      font-weight: 600;
      font-size: 1.1rem;
      margin: 0;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    .ai-chatbot-close {
      background: none;
      border: none;
      color: white;
      cursor: pointer;
      padding: 0.25rem;
      border-radius: 0.25rem;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .ai-chatbot-close:hover {
      background: rgba(255, 255, 255, 0.2);
    }
    
    .ai-chatbot-messages {
      flex: 1;
      overflow-y: auto;
      padding: 1.25rem;
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }
    
    .message {
      max-width: 80%;
      padding: 0.75rem 1rem;
      border-radius: 1rem;
      line-height: 1.5;
      font-size: 0.95rem;
    }
    
    .message.user {
      align-self: flex-end;
      background: #6366f1;
      color: white;
      border-bottom-right-radius: 0.25rem;
    }
    
    .message.assistant {
      align-self: flex-start;
      background: #f3f4f6;
      color: #1f2937;
      border-bottom-left-radius: 0.25rem;
    }
    
    .ai-chatbot-input {
      display: flex;
      padding: 1rem;
      border-top: 1px solid #e5e7eb;
      background: #f9fafb;
    }
    
    .ai-chatbot-input input {
      flex: 1;
      padding: 0.75rem 1rem;
      border: 1px solid #e5e7eb;
      border-radius: 0.5rem 0 0 0.5rem;
      outline: none;
      transition: border-color 0.2s;
    }
    
    .ai-chatbot-input input:focus {
      border-color: #6366f1;
    }
    
    .ai-chatbot-input button {
      background: #6366f1;
      color: white;
      border: none;
      padding: 0 1.25rem;
      border-radius: 0 0.5rem 0.5rem 0;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.2s;
    }
    
    .ai-chatbot-input button:hover {
      background: #4f46e5;
    }
    
    .typing-indicator {
      display: flex;
      gap: 0.25rem;
      padding: 0.5rem 1rem;
      background: #f3f4f6;
      border-radius: 1rem;
      width: fit-content;
      margin-bottom: 0.5rem;
    }
    
    .typing-indicator span {
      width: 8px;
      height: 8px;
      background: #9ca3af;
      border-radius: 50%;
      display: inline-block;
      animation: bounce 1.4s infinite ease-in-out both;
    }
    
    .typing-indicator span:nth-child(1) { animation-delay: -0.32s; }
    .typing-indicator span:nth-child(2) { animation-delay: -0.16s; }
    
    @keyframes bounce {
      0%, 80%, 100% { transform: scale(0); }
      40% { transform: scale(1); }
    }
    .question-card-pro table.likert-table input.option-input {
      background: transparent;
      border: none;
      font-weight: 500;
      color: #334155;
      width: 100%;
      outline: none;
      padding: 0.25rem 0.5rem;
    }
    .question-card-pro table.likert-table input.option-input:focus {
      background: #e0e7ff;
      border-radius: 0.375rem;
    }
    @media (max-width: 600px) {
      .question-card-pro table.likert-table th,
      .question-card-pro table.likert-table td {
        padding: 0.3rem 0.2rem;
        font-size: 0.85rem;
      }
    }
  </style>
</head>
<body class="bg-gradient-to-br from-blue-50 via-white to-purple-50 min-h-screen text-slate-800 antialiased relative overflow-x-hidden">

  <!-- Advanced Animated Background: Blobs, SVG Waves, and Floating Dots -->
  <div class="pointer-events-none select-none absolute inset-0 -z-10">
    <div class="blob bg-blue-200 animate-blob1" style="width:320px;height:320px;left:-120px;top:40px;filter:blur(32px);"></div>
    <div class="blob bg-green-200 animate-blob2" style="width:220px;height:220px;right:5%;top:140px;filter:blur(24px);"></div>
    <div class="blob bg-purple-200 animate-blob3" style="width:180px;height:180px;left:50%;bottom:-90px;filter:blur(28px);"></div>
    <!-- SVG Waves Top -->
    <svg class="absolute top-0 left-0 w-full h-32 md:h-40 lg:h-56 opacity-40" viewBox="0 0 1440 320">
      <path fill="#a5b4fc" fill-opacity="0.3" d="M0,224L48,197.3C96,171,192,117,288,117.3C384,117,480,171,576,197.3C672,224,768,224,864,197.3C960,171,1056,117,1152,117.3C1248,117,1344,171,1392,197.3L1440,224L1440,0L1392,0C1344,0,1248,0,1152,0C1056,0,960,0,864,0C768,0,672,0,576,0C480,0,384,0,288,0C192,0,96,0,48,0L0,0Z"></path>
      <path fill="#c7d2fe" fill-opacity="0.15" d="M0,160L60,154.7C120,149,240,139,360,154.7C480,171,600,213,720,208C840,203,960,149,1080,133.3C1200,117,1320,139,1380,149.3L1440,160L1440,0L1380,0C1320,0,1200,0,1080,0C960,0,840,0,720,0C600,0,480,0,360,0C240,0,120,0,60,0L0,0Z"></path>
    </svg>
    <!-- SVG Waves Bottom -->
    <svg class="absolute bottom-0 left-0 w-full h-32 md:h-40 lg:h-56 opacity-30" viewBox="0 0 1440 320">
      <path fill="#c7d2fe" fill-opacity="0.2" d="M0,288L48,272C96,256,192,224,288,197.3C384,171,480,149,576,154.7C672,160,768,192,864,197.3C960,203,1056,181,1152,176C1248,171,1344,181,1392,186.7L1440,192L1440,320L1392,320C1344,320,1248,320,1152,320C1056,320,960,320,864,320C768,320,672,320,576,320C480,320,384,320,288,320C192,320,96,320,48,320L0,320Z"></path>
      <path fill="#e0c3fc" fill-opacity="0.12" d="M0,320L80,293.3C160,267,320,213,480,197.3C640,181,800,203,960,213.3C1120,224,1280,224,1360,224L1440,224L1440,320L1360,320C1280,320,1120,320,960,320C800,320,640,320,480,320C320,320,160,320,80,320L0,320Z"></path>
    </svg>
    <!-- Animated Floating Dots -->
    <svg class="absolute left-1/4 top-1/3 w-24 h-24 opacity-60 animate-float-dot1" viewBox="0 0 100 100">
      <circle cx="50" cy="50" r="8" fill="#38bdf8" fill-opacity="0.18"/>
      <circle cx="70" cy="30" r="4" fill="#a5b4fc" fill-opacity="0.18"/>
      <circle cx="30" cy="70" r="3" fill="#b5ead7" fill-opacity="0.18"/>
    </svg>
    <svg class="absolute right-1/4 bottom-1/4 w-20 h-20 opacity-50 animate-float-dot2" viewBox="0 0 100 100">
      <circle cx="40" cy="60" r="6" fill="#e0c3fc" fill-opacity="0.18"/>
      <circle cx="70" cy="30" r="3" fill="#38bdf8" fill-opacity="0.18"/>
    </svg>
  </div>

  <!-- Sticky Navigation -->
  <nav class="sticky top-0 z-30 bg-white/90 backdrop-blur border-b border-slate-100">
    <div class="max-w-7xl mx-auto px-4 sm:px-8 flex items-center justify-between h-16">
      <div class="flex items-center gap-3">
        <a href="index.html" class="flex items-center gap-3">
          <svg width="32" height="32" fill="none" viewBox="0 0 48 48">
            <rect x="4" y="8" width="40" height="32" rx="8" fill="#38bdf8"/>
            <rect x="12" y="16" width="24" height="16" rx="4" fill="#34d399"/>
          </svg>
          <span class="font-semibold text-lg tracking-tight text-slate-800">SmartSurvey</span>
        </a>
      </div>
      <div class="hidden md:flex gap-8 text-sm font-medium">
        <div class="relative group">
          <button id="featuresBtn" type="button" class="text-gray-600 hover:text-blue-600 transition font-medium flex items-center gap-1 focus:outline-none">
            Features
            <svg class="w-4 h-4 ml-1" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
              <path d="M19 9l-7 7-7-7"/>
            </svg>
          </button>
          <div id="featuresDropdown" class="absolute left-0 mt-2 w-64 bg-white rounded-xl shadow-lg border border-gray-100 py-2 opacity-0 pointer-events-none group-hover:opacity-100 group-hover:pointer-events-auto transition-all duration-200 z-30 flex">
            <div class="flex flex-col w-full">
              <a href="survey-creation.html" class="block px-5 py-2 text-gray-700 hover:bg-blue-50 rounded-lg transition">Survey Creation</a>
              <a href="distribution.html" class="block px-5 py-2 text-gray-700 hover:bg-blue-50 rounded-lg transition">Distribution & Sharing</a>
              <a href="survey-analytics.html" class="block px-5 py-2 text-gray-700 hover:bg-blue-50 rounded-lg transition">Response Collection</a>
            </div>
          </div>
        </div>
        <a href="index.html#how" class="hover:text-sky-500 transition-colors">How it Works</a>
        <a href="view-survey.html" class="hover:text-sky-500 transition-colors">View Surveys</a>
        <a href="survey-analytics.html" class="hover:text-sky-500 transition-colors">Response Collection</a>
        <a href="index.html#contact" class="hover:text-sky-500 transition-colors">Contact</a>
      </div>
      <div class="flex gap-2">
        <a href="login.html" id="login-button" class="rounded-lg px-4 py-2 font-medium hover:bg-sky-50 text-sky-600 transition-colors">Login</a>
        <a href="login.html" id="signup-button" class="rounded-lg px-4 py-2 font-medium bg-sky-500 text-white shadow hover:bg-sky-600 transition-colors">Sign Up</a>
        <button id="logout-button" class="rounded-lg px-4 py-2 font-medium bg-red-500 text-white shadow hover:bg-red-600 transition-colors" style="display:none;">Logout</button>
      </div>
    </div>
  </nav>

  <!-- Survey Builder Main Content (Sidebar on left, builder on right) -->
  <div class="max-w-7xl mx-auto flex flex-row gap-8 px-2 md:px-8 py-8 md:py-12">
    <!-- Sidebar: Question Types & Templates -->
    <div class="w-full max-w-xs flex-shrink-0 self-start pt-2 sidebar-pro">
      <div class="rounded-2xl p-6">
        <h2 class="text-xl font-semibold mb-4 text-slate-800">Question Types</h2>
        <ul class="space-y-2 mb-8">
          <li class="flex items-center gap-2 text-blue-600 font-medium active" style="cursor:pointer"><i data-lucide="radio"></i> Multiple Choice</li>
          <li class="flex items-center gap-2 text-slate-600" style="cursor:pointer"><i data-lucide="check-square"></i> Checkbox</li>
          <li class="flex items-center gap-2 text-slate-600" style="cursor:pointer"><i data-lucide="type"></i> Text Input</li>
          <li class="flex items-center gap-2 text-slate-600" style="cursor:pointer"><i data-lucide="align-left"></i> Long Text</li>
          <li class="flex items-center gap-2 text-slate-600" style="cursor:pointer"><i data-lucide="star"></i> Rating Scale</li>
          <li class="flex items-center gap-2 text-slate-600" style="cursor:pointer"><i data-lucide="bar-chart-2"></i> Likert Scale</li>
          <li class="flex items-center gap-2 text-slate-600" style="cursor:pointer"><i data-lucide="calendar"></i> Date Picker</li>
        </ul>
        
        <!-- Predefined Question Sets -->
        <div class="mb-6">
          <div class="font-semibold text-slate-700 mb-2">Predefined Question Sets</div>
          <div class="space-y-2">
            <div class="predefined-set group flex items-center gap-2 p-2 rounded-lg cursor-pointer hover:bg-blue-50 transition-colors border border-transparent hover:border-blue-200" data-set="customer-feedback">
              <div class="w-8 h-8 rounded-lg bg-blue-100 flex items-center justify-center text-blue-600 group-hover:bg-blue-200 transition-colors">
                <i data-lucide="users" class="w-4 h-4"></i>
              </div>
              <div>
                <div class="font-medium text-sm text-slate-800">Customer Feedback</div>
                <div class="text-xs text-slate-500">5 essential questions</div>
              </div>
            </div>
            
            <div class="predefined-set group flex items-center gap-2 p-2 rounded-lg cursor-pointer hover:bg-blue-50 transition-colors border border-transparent hover:border-blue-200" data-set="employee-feedback">
              <div class="w-8 h-8 rounded-lg bg-purple-100 flex items-center justify-center text-purple-600 group-hover:bg-purple-200 transition-colors">
                <i data-lucide="briefcase" class="w-4 h-4"></i>
              </div>
              <div>
                <div class="font-medium text-sm text-slate-800">Employee Feedback</div>
                <div class="text-xs text-slate-500">6 key questions</div>
              </div>
            </div>
            
            <div class="predefined-set group flex items-center gap-2 p-2 rounded-lg cursor-pointer hover:bg-blue-50 transition-colors border border-transparent hover:border-blue-200" data-set="product-review">
              <div class="w-8 h-8 rounded-lg bg-green-100 flex items-center justify-center text-green-600 group-hover:bg-green-200 transition-colors">
                <i data-lucide="package" class="w-4 h-4"></i>
              </div>
              <div>
                <div class="font-medium text-sm text-slate-800">Product Review</div>
                <div class="text-xs text-slate-500">7 detailed questions</div>
              </div>
            </div>
          </div>
        </div>
        
        <div>
          <div class="font-semibold text-slate-700 mb-2">Survey Templates</div>
          <div class="bg-blue-50 rounded-xl p-3 space-y-2 text-sm">
            <div class="hover:bg-blue-100 rounded px-2 py-1 cursor-pointer text-blue-700">Customer Satisfaction</div>
            <div class="hover:bg-blue-100 rounded px-2 py-1 cursor-pointer">Employee Feedback</div>
            <div class="hover:bg-blue-100 rounded px-2 py-1 cursor-pointer">Product Review</div>
          </div>
        </div>
      </div>
    </div>
    <!-- Main Survey Builder Area (right side) -->
    <div class="flex-1 flex flex-col gap-6">
      <!-- Preview, Save & Publish Buttons (top right, just below navbar) -->
      <div class="flex justify-end gap-2 mb-4">
        <button id="previewBtn" class="survey-btn-pro px-4 py-2 rounded-lg bg-white border border-gray-200 text-gray-700 font-medium shadow hover:bg-gray-50 transition flex items-center gap-2">
          <i data-lucide="eye"></i> Preview
        </button>
        <button id="saveBtn" class="survey-btn-pro px-4 py-2 rounded-lg bg-blue-600 text-white font-semibold shadow hover:bg-blue-700 transition flex items-center gap-2">
          <i data-lucide="save"></i> Save Survey
        </button>
      </div>
      <!-- Survey Title Card -->
      <div class="survey-card-pro p-6">
        <input
          id="surveyTitle"
          class="w-full text-xl font-semibold mb-2 bg-transparent focus:outline-none"
          value="Customer Satisfaction Survey"
        />
        <textarea
          id="surveyDesc"
          class="w-full text-slate-500 text-sm bg-transparent focus:outline-none resize-none"
          rows="2"
        >Help us improve our service by sharing your feedback.</textarea>
      </div>
      <!-- Questions List -->
      <div id="questionsContainer" class="flex flex-col gap-6">
        <!-- Questions will be rendered here -->
      </div>
      <!-- Add Question Button -->
      <div class="flex justify-center">
        <button id="addQuestionBtn" class="survey-btn-pro flex items-center gap-2 px-6 py-2 rounded-lg bg-blue-600 text-white font-semibold shadow hover:bg-blue-700 transition">
          <i data-lucide="plus"></i> Add Question
        </button>
      </div>
    </div>
  </div>
  <script>
    lucide.createIcons();

    // Survey Templates Data
    const SURVEY_TEMPLATES = [
      {
        id: 'customer-feedback',
        name: 'Customer Feedback',
        description: 'Collect feedback from your customers about their experience',
        icon: 'users',
        questions: [
          {
            type: 'rating',
            text: 'How would you rate your overall experience with our product/service?',
            required: true,
            options: ['1 - Poor', '2', '3 - Average', '4', '5 - Excellent']
          },
          {
            type: 'text',
            text: 'What did you like most about our product/service?',
            required: false
          },
          {
            type: 'text',
            text: 'What could we improve?',
            required: false
          },
          {
            type: 'mcq',
            text: 'How likely are you to recommend us to others?',
            required: true,
            options: ['Very Likely', 'Likely', 'Neutral', 'Unlikely', 'Very Unlikely']
          }
        ]
      },
      {
        id: 'employee-engagement',
        name: 'Employee Engagement',
        description: 'Measure employee satisfaction and engagement',
        icon: 'users-2',
        questions: [
          {
            type: 'rating',
            text: 'How satisfied are you with your current role and responsibilities?',
            required: true,
            options: ['1 - Very Dissatisfied', '2', '3 - Neutral', '4', '5 - Very Satisfied']
          },
          {
            type: 'text',
            text: 'What do you enjoy most about working here?',
            required: false
          },
          {
            type: 'text',
            text: 'What could we improve about the work environment?',
            required: false
          },
          {
            type: 'mcq',
            text: 'Do you feel your work is valued and recognized?',
            required: true,
            options: ['Always', 'Often', 'Sometimes', 'Rarely', 'Never']
          }
        ]
      },
      {
        id: 'event-feedback',
        name: 'Event Feedback',
        description: 'Gather feedback after an event or conference',
        icon: 'calendar',
        questions: [
          {
            type: 'rating',
            text: 'How would you rate the overall event?',
            required: true,
            options: ['1 - Poor', '2', '3 - Average', '4', '5 - Excellent']
          },
          {
            type: 'text',
            text: 'What was your favorite part of the event?',
            required: false
          },
          {
            type: 'text',
            text: 'What could be improved for future events?',
            required: false
          },
          {
            type: 'mcq',
            text: 'Would you attend this event again?',
            required: true,
            options: ['Definitely', 'Probably', 'Not Sure', 'Probably Not', 'Definitely Not']
          }
        ]
      }
    ];

    // Function to load a template
    function loadTemplate(template) {
      // Update survey title with template name
      const surveyTitleInput = document.getElementById('surveyTitle');
      if (surveyTitleInput) {
        surveyTitleInput.value = `${template.name} Survey`;
      }
      
      // Clear existing questions
      questions = [];
      
      // Add questions from template
      template.questions.forEach(questionData => {
        const newQuestion = {
          type: questionData.type,
          text: questionData.text,
          required: questionData.required || false,
          options: questionData.options ? [...questionData.options] : []
        };
        
        // Add the question to the questions array
        questions.push(newQuestion);
      });
      
      // Set the first question as active
      activeQuestionIndex = questions.length > 0 ? 0 : -1;
      
      // Re-render questions
      renderQuestions();
      
      // Show success notification
      showNotification({
        title: 'Template Loaded',
        message: `${template.name} template has been loaded successfully!`,
        type: 'success',
        duration: 3000
      });
    }

    // Function to show notification
    function showNotification({ title = '', message = '', type = 'info', duration = 3000 }) {
      // Create notification container if it doesn't exist
      let container = document.getElementById('notification-container');
      if (!container) {
        container = document.createElement('div');
        container.id = 'notification-container';
        container.className = 'fixed top-4 right-4 z-50 space-y-2 w-80';
        document.body.appendChild(container);
      }

      // Create notification element
      const notification = document.createElement('div');
      const typeClasses = {
        success: 'bg-green-100 border-green-400 text-green-700',
        error: 'bg-red-100 border-red-400 text-red-700',
        warning: 'bg-yellow-100 border-yellow-400 text-yellow-700',
        info: 'bg-blue-100 border-blue-400 text-blue-700'
      };

      notification.className = `border-l-4 p-4 rounded shadow-lg ${typeClasses[type] || typeClasses.info} animate-slide-in`;
      
      // Add notification content
      notification.innerHTML = `
        <div class="flex justify-between items-start">
          <div>
            ${title ? `<h4 class="font-bold">${title}</h4>` : ''}
            <p class="text-sm">${message}</p>
          </div>
          <button class="close-notification ml-2">
            <i data-lucide="x" class="w-4 h-4"></i>
          </button>
        </div>
      `;

      // Add close functionality
      const closeBtn = notification.querySelector('.close-notification');
      const closeNotification = () => {
        notification.classList.remove('animate-slide-in');
        notification.classList.add('animate-slide-out');
        setTimeout(() => notification.remove(), 300);
      };

      closeBtn.addEventListener('click', closeNotification);

      // Auto-remove after duration
      let timeoutId = setTimeout(closeNotification, duration);

      // Pause auto-remove on hover
      notification.addEventListener('mouseenter', () => clearTimeout(timeoutId));
      notification.addEventListener('mouseleave', () => {
        timeoutId = setTimeout(closeNotification, duration);
      });

      // Add to container
      container.appendChild(notification);
      
      // Initialize Lucide icons
      lucide.createIcons();
      
      return notification;
    }

    // Add animation styles
    const style = document.createElement('style');
    style.textContent = `
      @keyframes slideIn {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
      }
      @keyframes slideOut {
        from { transform: translateX(0); opacity: 1; }
        to { transform: translateX(100%); opacity: 0; }
      }
      .animate-slide-in {
        animation: slideIn 0.3s ease-out forwards;
      }
      .animate-slide-out {
        animation: slideOut 0.3s ease-out forwards;
      }
    `;
    document.head.appendChild(style);

    // Function to show template selection modal
    function showTemplatesModal() {
      const modal = document.createElement('div');
      modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
      
      const modalContent = document.createElement('div');
      modalContent.className = 'bg-white rounded-xl p-6 w-full max-w-2xl max-h-[80vh] overflow-y-auto';
      
      modalContent.innerHTML = `
        <div class="flex justify-between items-center mb-6">
          <h3 class="text-xl font-semibold text-slate-800">Choose a Template</h3>
          <button class="close-btn p-2 hover:bg-gray-100 rounded-full">
            <i data-lucide="x" class="w-5 h-5"></i>
          </button>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          ${SURVEY_TEMPLATES.map(template => `
            <div class="border rounded-lg p-4 hover:border-blue-400 transition-colors cursor-pointer template-card" data-template-id="${template.id}">
              <div class="flex items-center gap-3 mb-2">
                <div class="bg-blue-50 p-2 rounded-lg">
                  <i data-lucide="${template.icon}" class="w-5 h-5 text-blue-600"></i>
                </div>
                <h4 class="font-medium text-slate-800">${template.name}</h4>
              </div>
              <p class="text-sm text-slate-500 mb-3">${template.description}</p>
              <div class="text-xs text-slate-400">${template.questions.length} questions</div>
            </div>
          `).join('')}
        </div>
      `;
      
      // Close modal when clicking outside or on close button
      modal.addEventListener('click', (e) => {
        if (e.target === modal || e.target.closest('.close-btn')) {
          modal.remove();
        }
      });
      
      // Handle template selection
      modalContent.querySelectorAll('.template-card').forEach(card => {
        card.addEventListener('click', () => {
          const templateId = card.dataset.templateId;
          const template = SURVEY_TEMPLATES.find(t => t.id === templateId);
          if (template) {
            loadTemplate(template);
            modal.remove();
          }
        });
      });
      
      modal.appendChild(modalContent);
      document.body.appendChild(modal);
      lucide.createIcons();
    }

    // Initialize template button
    document.addEventListener('DOMContentLoaded', () => {
      const templateBtn = document.createElement('button');
      templateBtn.className = 'survey-btn-pro px-4 py-2 rounded-lg bg-white border border-gray-200 text-gray-700 font-medium shadow hover:bg-gray-50 transition flex items-center gap-2';
      templateBtn.innerHTML = '<i data-lucide="layout-template"></i> Templates';
      templateBtn.addEventListener('click', showTemplatesModal);
      
      // Add template button next to the preview button
      const previewBtn = document.getElementById('previewBtn');
      previewBtn.parentNode.insertBefore(templateBtn, previewBtn.nextSibling);
      
      // Initialize Lucide icons
      lucide.createIcons();
    });

    // Dropdown logic for Features
    const btn = document.getElementById('featuresBtn');
    const dropdown = document.getElementById('featuresDropdown');
    btn.addEventListener('click', function(e) {
      e.preventDefault();
      dropdown.classList.toggle('opacity-0');
      dropdown.classList.toggle('pointer-events-none');
    });
    document.addEventListener('click', function(e) {
      if (!btn.contains(e.target) && !dropdown.contains(e.target)) {
        dropdown.classList.add('opacity-0', 'pointer-events-none');
      }
    });

    // Question Types
    const QUESTION_TYPES = [
      { type: 'mcq', label: 'Multiple Choice', icon: 'radio' },
      { type: 'checkbox', label: 'Checkbox', icon: 'check-square' },
      { type: 'text', label: 'Text Input', icon: 'type' },
      { type: 'textarea', label: 'Long Text', icon: 'align-left' },
      { type: 'rating', label: 'Rating Scale', icon: 'star' },
      { type: 'likert', label: 'Likert Scale', icon: 'bar-chart-2' },
      { type: 'date', label: 'Date Picker', icon: 'calendar' }
      // Removed Image Choice
    ];

    // Initial questions array
    let questions = [
      {
        type: 'mcq',
        text: 'How satisfied are you with our service?',
        required: true,
        options: [
          'Very Satisfied',
          'Satisfied',
          'Neutral',
          'Dissatisfied',
          'Very Dissatisfied'
        ]
      }
    ];
    let activeQuestionIndex = 0;

    // Render all questions
    function renderQuestions() {
      const container = document.getElementById('questionsContainer');
      container.innerHTML = '';
      questions.forEach((q, idx) => {
        const isActive = idx === activeQuestionIndex;
        const qType = QUESTION_TYPES.find(t => t.type === q.type);
        let optionsHtml = '';
        if (q.type === 'mcq' || q.type === 'checkbox' || q.type === 'image') {
          optionsHtml = `
            <div id="optionsList${idx}" class="space-y-2 mb-2">
              ${q.options.map((opt, oidx) => `
                <div class="flex items-center gap-2">
                  <input type="${q.type === 'mcq' ? 'radio' : q.type === 'checkbox' ? 'checkbox' : 'radio'}" name="q${idx}" class="accent-blue-500" disabled>
                  <input class="option-input bg-transparent focus:outline-none flex-1" value="${opt.replace(/"/g, '&quot;')}" data-qidx="${idx}" data-oidx="${oidx}" ${isActive ? '' : 'readonly'}>
                  ${isActive ? `<button class="remove-option text-gray-400 hover:text-red-500" title="Remove Option" tabindex="-1" data-qidx="${idx}" data-oidx="${oidx}">&times;</button>` : ''}
                </div>
              `).join('')}
            </div>
            ${isActive ? `<div class="pl-7"><button class="addOptionBtn text-blue-600 text-sm hover:underline" data-qidx="${idx}">+ Add Option</button></div>` : ''}
          `;
        }
        if (q.type === 'likert') {
          optionsHtml = `
            <div class="overflow-x-auto mb-2">
              <table class="likert-table">
                <thead>
                  <tr>
                    <th class="text-left pr-4 bg-white"></th>
                    ${['Strongly Disagree', 'Disagree', 'Neutral', 'Agree', 'Strongly Agree'].map(l => `<th>${l}</th>`).join('')}
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="pr-4">
                      <input class="option-input bg-transparent focus:outline-none" value="${q.likertStatement || 'Statement'}" data-qidx="${idx}" data-likert="1" ${isActive ? '' : 'readonly'}>
                    </td>
                    ${[1,2,3,4,5].map(i => `<td><input type="radio" disabled></td>`).join('')}
                  </tr>
                </tbody>
              </table>
            </div>
          `;
        }
        if (q.type === 'rating') {
          optionsHtml = `
            <div class="flex items-center gap-1 mb-2">
              ${[1,2,3,4,5].map(i => `<svg data-lucide="star" class="w-6 h-6 text-yellow-400" fill="none"></svg>`).join('')}
            </div>
          `;
        }
        if (q.type === 'date') {
          optionsHtml = `
            <div class="mb-2">
              <input type="date" class="border rounded px-3 py-1 text-slate-700 bg-white" disabled>
            </div>
          `;
        }
        if (q.type === 'text') {
          optionsHtml = `
            <div class="mb-2">
              <input type="text" class="border rounded px-3 py-1 text-slate-700 bg-white w-full" placeholder="Your answer..." disabled>
            </div>
          `;
        }
        if (q.type === 'textarea') {
          optionsHtml = `
            <div class="mb-2">
              <textarea class="border rounded px-3 py-1 text-slate-700 bg-white w-full" rows="3" placeholder="Your answer..." disabled></textarea>
            </div>
          `;
        }

        container.innerHTML += `
          <div class="question-card-pro p-6 relative group" data-qidx="${idx}">
            <div class="flex items-center gap-2 mb-4">
              <span class="w-7 h-7 rounded-full bg-blue-100 text-blue-700 flex items-center justify-center font-bold">${idx+1}</span>
              <span class="bg-blue-50 text-blue-600 rounded px-2 py-1 text-xs flex items-center gap-1"><i data-lucide="${qType.icon}"></i> ${qType.label}</span>
              <input
                class="ml-2 font-medium text-slate-800 bg-transparent focus:outline-none w-full questionText"
                value="${q.text.replace(/"/g, '&quot;')}"
                data-qidx="${idx}"
                ${isActive ? '' : 'readonly'}
              />
              <span class="text-red-500">${q.required ? '*' : ''}</span>
              ${isActive ? `
                <button class="delete-question ml-2 text-gray-400 hover:text-red-500" title="Delete Question" data-qidx="${idx}"><i data-lucide="trash-2"></i></button>
              ` : ''}
            </div>
            ${optionsHtml}
            <div class="flex items-center justify-between mt-4">
              <label class="flex items-center gap-2 text-sm text-blue-600">
                <input type="checkbox" class="requiredCheckbox accent-blue-500" data-qidx="${idx}" ${q.required ? 'checked' : ''} ${isActive ? '' : 'disabled'}>
                Required
              </label>
              <div class="flex items-center gap-4">
                ${isActive ? `<button class="logicBtn text-gray-400 hover:text-blue-600 flex items-center gap-1" data-qidx="${idx}"><i data-lucide="settings"></i> Logic</button>` : ''}
              </div>
            </div>
            ${!isActive ? `<button class="absolute top-2 right-2 text-xs text-blue-500 hover:underline focus:outline-none focus:ring" data-action="edit" data-qidx="${idx}">Edit</button>` : ''}
          </div>
        `;
      });
      lucide.createIcons();
    }
    renderQuestions();

    // Question Type Buttons
    document.querySelectorAll('.sidebar-pro .space-y-2 > li').forEach((li, idx, arr) => {
      li.addEventListener('click', function() {
        arr.forEach(l => l.classList.remove('active', 'text-blue-600', 'font-medium'));
        li.classList.add('active', 'text-blue-600', 'font-medium');
        // Add new question of this type and set as active
        questions.push({
          type: QUESTION_TYPES[idx].type,
          text: QUESTION_TYPES[idx].label + ' question',
          required: false,
          options: (['mcq','checkbox','image'].includes(QUESTION_TYPES[idx].type)) ? ['Option 1','Option 2'] : undefined,
          likertStatement: QUESTION_TYPES[idx].type === 'likert' ? 'Statement' : undefined
        });
        activeQuestionIndex = questions.length - 1;
        renderQuestions();
      });
    });

    // Add Option, Remove Option, Delete Question, Edit, Logic
    document.addEventListener('click', function(e) {
      // Add Option
      if (e.target.classList.contains('addOptionBtn')) {
        const qidx = +e.target.dataset.qidx;
        questions[qidx].options.push('New Option');
        renderQuestions();
        return;
      }
      // Remove Option
      if (e.target.classList.contains('remove-option')) {
        const qidx = +e.target.dataset.qidx;
        const oidx = +e.target.dataset.oidx;
        questions[qidx].options.splice(oidx, 1);
        renderQuestions();
        return;
      }
      // Delete Question (fix: handle SVG icon click inside button)
      if (
        e.target.classList.contains('delete-question') ||
        (e.target.closest('.delete-question'))
      ) {
        let btn = e.target.classList.contains('delete-question')
          ? e.target
          : e.target.closest('.delete-question');
        const qidx = +btn.dataset.qidx;
        questions.splice(qidx, 1);
        if (activeQuestionIndex >= questions.length) activeQuestionIndex = questions.length - 1;
        renderQuestions();
        return;
      }
      // Delete via Edit button if delete is visible
      if (
        e.target.dataset.action === 'edit' &&
        e.target.closest('.question-card-pro').querySelector('.delete-question')
      ) {
        const qidx = +e.target.dataset.qidx;
        questions.splice(qidx, 1);
        if (activeQuestionIndex >= questions.length) activeQuestionIndex = questions.length - 1;
        renderQuestions();
        return;
      }
      // Edit Question (only if delete is not visible)
      if (
        e.target.dataset.action === 'edit' &&
        !e.target.closest('.question-card-pro').querySelector('.delete-question')
      ) {
        activeQuestionIndex = +e.target.dataset.qidx;
        renderQuestions();
        return;
      }
      // Logic Button
      if (e.target.classList.contains('logicBtn')) {
        alert('Logic settings can be implemented here.');
        return;
      }
    });

    // Edit question text
    document.addEventListener('input', function(e) {
      if (e.target.classList.contains('questionText')) {
        const qidx = +e.target.dataset.qidx;
        questions[qidx].text = e.target.value;
      }
      if (e.target.classList.contains('option-input')) {
        const qidx = +e.target.dataset.qidx;
        const oidx = +e.target.dataset.oidx;
        if (typeof oidx !== 'undefined' && questions[qidx].options) {
          questions[qidx].options[oidx] = e.target.value;
        }
        if (e.target.dataset.likert === '1') {
          questions[qidx].likertStatement = e.target.value;
        }
      }
    });

    // Required checkbox
    document.addEventListener('change', function(e) {
      if (e.target.classList.contains('requiredCheckbox')) {
        const qidx = +e.target.dataset.qidx;
        questions[qidx].required = e.target.checked;
      }
    });

    // Add Question Button
    document.getElementById('addQuestionBtn').addEventListener('click', function(e) {
      e.preventDefault();
      // Add a new question of the same type as the last active question
      const lastType = questions[activeQuestionIndex]?.type || 'mcq';
      let newQ = {
        type: lastType,
        text: QUESTION_TYPES.find(t=>t.type===lastType)?.label + ' question',
        required: false,
        options: (['mcq','checkbox','image'].includes(lastType)) ? ['Option 1','Option 2'] : undefined,
        likertStatement: lastType === 'likert' ? 'Statement' : undefined
      };
      questions.push(newQ);
      activeQuestionIndex = questions.length - 1;
      renderQuestions();
    });

    // Preview Button
    document.getElementById('previewBtn').addEventListener('click', function() {
      // Create a modal overlay
      let modal = document.createElement('div');
      modal.id = 'previewModal';
      modal.style.position = 'fixed';
      modal.style.top = 0;
      modal.style.left = 0;
      modal.style.width = '100vw';
      modal.style.height = '100vh';
      modal.style.background = 'rgba(30,41,59,0.25)';
      modal.style.zIndex = 1000;
      modal.style.display = 'flex';
      modal.style.alignItems = 'center';
      modal.style.justifyContent = 'center';

      // Modal content
      let content = document.createElement('div');
      content.style.background = 'white';
      content.style.borderRadius = '1.25rem';
      content.style.boxShadow = '0 8px 32px 0 rgba(56,189,248,0.13), 0 2px 8px 0 rgba(80,120,255,0.07)';
      content.style.maxWidth = '600px';
      content.style.width = '95vw';
      content.style.maxHeight = '90vh';
      content.style.overflowY = 'auto';
      content.style.padding = '2rem 1.5rem 1.5rem 1.5rem';
      content.style.position = 'relative';

      // Close button
      let closeBtn = document.createElement('button');
      closeBtn.innerHTML = '<svg data-lucide="x" class="w-6 h-6"></svg>';
      closeBtn.style.position = 'absolute';
      closeBtn.style.top = '1rem';
      closeBtn.style.right = '1rem';
      closeBtn.style.background = 'none';
      closeBtn.style.border = 'none';
      closeBtn.style.cursor = 'pointer';
      closeBtn.style.color = '#64748b';
      closeBtn.setAttribute('aria-label', 'Close preview');
      closeBtn.addEventListener('click', function() {
        document.body.removeChild(modal);
      });

      // Survey title and description
      let title = document.createElement('div');
      title.innerHTML = `
        <div class="text-2xl font-bold mb-1">${document.getElementById('surveyTitle').value}</div>
        <div class="text-slate-500 mb-4">${document.getElementById('surveyDesc').value}</div>
      `;

      // Questions preview
      let questionsHtml = questions.map((q, idx) => {
        let qHtml = `<div class="mb-6">
          <div class="font-medium text-slate-800 mb-2">${idx+1}. ${q.text} ${q.required ? '<span class="text-red-500">*</span>' : ''}</div>`;
        if (q.type === 'mcq') {
          qHtml += q.options.map(opt =>
            `<label class="flex items-center gap-2 mb-1">
              <input type="radio" name="preview_q${idx}" class="accent-blue-500" disabled>
              <span>${opt}</span>
            </label>`
          ).join('');
        }
        if (q.type === 'checkbox') {
          qHtml += q.options.map(opt =>
            `<label class="flex items-center gap-2 mb-1">
              <input type="checkbox" name="preview_q${idx}" class="accent-blue-500" disabled>
              <span>${opt}</span>
            </label>`
          ).join('');
        }
        if (q.type === 'text') {
          qHtml += `<input type="text" class="border rounded px-3 py-1 text-slate-700 bg-white w-full" placeholder="Your answer..." disabled>`;
        }
        if (q.type === 'textarea') {
          qHtml += `<textarea class="border rounded px-3 py-1 text-slate-700 bg-white w-full" rows="3" placeholder="Your answer..." disabled></textarea>`;
        }
        if (q.type === 'rating') {
          qHtml += `<div class="flex items-center gap-1 mb-2">
            ${[1,2,3,4,5].map(i => `<svg data-lucide="star" class="w-6 h-6 text-yellow-400" fill="none"></svg>`).join('')}
          </div>`;
        }
        if (q.type === 'likert') {
          qHtml += `
            <div class="overflow-x-auto mb-2">
              <table class="likert-table w-full">
                <thead>
                  <tr>
                    <th class="text-left pr-4 bg-white"></th>
                    ${['Strongly Disagree', 'Disagree', 'Neutral', 'Agree', 'Strongly Agree'].map(l => `<th>${l}</th>`).join('')}
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="pr-4">${q.likertStatement || 'Statement'}</td>
                    ${[1,2,3,4,5].map(i => `<td><input type="radio" disabled></td>`).join('')}
                  </tr>
                </tbody>
              </table>
            </div>
          `;
        }
        if (q.type === 'date') {
          qHtml += `<input type="date" class="border rounded px-3 py-1 text-slate-700 bg-white" disabled>`;
        }
        qHtml += `</div>`;
        return qHtml;
      }).join('');

      content.appendChild(closeBtn);
      content.appendChild(title);
      let qWrap = document.createElement('div');
      qWrap.innerHTML = questionsHtml;
      content.appendChild(qWrap);

      modal.appendChild(content);
      document.body.appendChild(modal);
      lucide.createIcons();
    });

    // Save Button
    // Function to save survey to localStorage
    async function saveSurvey(isPublished = false) {
      const surveyTitle = document.getElementById('surveyTitle').value;
      const surveyDesc = document.getElementById('surveyDesc').value;

      if (!surveyTitle) {
        alert('Please enter a survey title');
        return false;
      }

      const surveyData = {
        id: Date.now().toString(),
        title: surveyTitle,
        description: surveyDesc || 'No description provided',
        questions: questions.map(q => ({
          questionText: q.text,
          questionType: q.type === 'mcq' ? 'multiple-choice' : q.type,
          options: q.options || []
        })),
        createdAt: new Date().toISOString(),
        status: isPublished ? 'published' : 'draft',
        responses: 0,
        responseGoal: 100,
        expires: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
        createdBy: 'You'
      };

      try {
        // Save to localStorage
        const existingSurveys = JSON.parse(localStorage.getItem('surveys') || '[]');
        existingSurveys.push(surveyData);
        localStorage.setItem('surveys', JSON.stringify(existingSurveys));
        
        // Try to save to backend if available
        try {
          const response = await fetch('http://localhost:4000/api/surveys', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(surveyData)
          });
          
          if (!response.ok) {
            const result = await response.json();
            console.warn('Backend save failed, but saved to localStorage:', result.error);
          }
        } catch (backendError) {
          console.warn('Could not connect to backend, but saved to localStorage', backendError);
        }
        
        // Show success message
        alert(`Survey ${isPublished ? 'published' : 'saved'} successfully!`);
        
        // If published, redirect to view-survey page
        if (isPublished) {
          window.location.href = 'view-survey.html';
        } else {
          window.location.reload();
        }
        return true;
      } catch (error) {
        console.error('Failed to save survey:', error);
        alert('An error occurred while saving the survey. Please check the console for details.');
        return false;
      }
    }

    // Save and Publish buttons click handler
    document.getElementById('saveBtn').addEventListener('click', function() {
      saveSurvey(false);
    });


    // Survey title/desc
    document.getElementById('surveyTitle').addEventListener('input', function(e) {
      // You can store this in a variable if needed
    });
    document.getElementById('surveyDesc').addEventListener('input', function(e) {
      // You can store this in a variable if needed
    });
  </script>
  <script src="js/auth.js"></script>
  <!-- AI Chatbot Button -->
  <div class="ai-chatbot">
    <button id="aiChatbotBtn" class="ai-chatbot-btn" aria-label="AI Assistant">
      <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M12 8V16"/>
        <path d="M8 12H16"/>
        <rect width="18" height="18" x="3" y="3" rx="2"/>
      </svg>
    </button>
    
    <div id="aiChatbotPanel" class="ai-chatbot-panel">
      <div class="ai-chatbot-header">
        <h3><i data-lucide="bot"></i> AI Survey Assistant</h3>
        <button id="aiChatbotClose" class="ai-chatbot-close" aria-label="Close">
          <i data-lucide="x"></i>
        </button>
      </div>
      
      <div id="aiChatbotMessages" class="ai-chatbot-messages">
        <div class="message assistant">
          Hello! I'm your AI Survey Assistant. I can help you create better surveys, suggest questions, and provide feedback on your survey structure. How can I assist you today?
        </div>
      </div>
      
      <div class="ai-chatbot-input">
        <input type="text" id="aiChatbotInput" placeholder="Ask me anything about creating surveys..." />
        <button id="aiChatbotSend">
          <i data-lucide="send"></i>
        </button>
      </div>
    </div>
  </div>

  <script>
    // AI Chatbot functionality
    document.addEventListener('DOMContentLoaded', function() {
      const chatbotBtn = document.getElementById('aiChatbotBtn');
      const chatbotPanel = document.getElementById('aiChatbotPanel');
      const chatbotClose = document.getElementById('aiChatbotClose');
      const chatbotMessages = document.getElementById('aiChatbotMessages');
      const chatbotInput = document.getElementById('aiChatbotInput');
      const chatbotSend = document.getElementById('aiChatbotSend');
      
      // Toggle chatbot panel
      chatbotBtn.addEventListener('click', function() {
        chatbotPanel.classList.toggle('active');
        if (chatbotPanel.classList.contains('active')) {
          chatbotInput.focus();
        }
      });
      
      // Close chatbot panel
      chatbotClose.addEventListener('click', function() {
        chatbotPanel.classList.remove('active');
      });
      
      // Send message on button click
      chatbotSend.addEventListener('click', sendMessage);
      
      // Send message on Enter key
      chatbotInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
          sendMessage();
        }
      });
      
      // Function to add a message to the chat
      function addMessage(content, isUser = false) {
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${isUser ? 'user' : 'assistant'}`;
        messageDiv.textContent = content;
        chatbotMessages.appendChild(messageDiv);
        chatbotMessages.scrollTop = chatbotMessages.scrollHeight;
      }
      
      // Function to show typing indicator
      function showTypingIndicator() {
        const typingDiv = document.createElement('div');
        typingDiv.className = 'typing-indicator';
        typingDiv.innerHTML = '<span></span><span></span><span></span>';
        typingDiv.id = 'typingIndicator';
        chatbotMessages.appendChild(typingDiv);
        chatbotMessages.scrollTop = chatbotMessages.scrollHeight;
      }
      
      // Function to hide typing indicator
      function hideTypingIndicator() {
        const typingIndicator = document.getElementById('typingIndicator');
        if (typingIndicator) {
          typingIndicator.remove();
        }
      }
      
      // Function to wait for GoogleGenerativeAI to be available
      function waitForGemini() {
        return new Promise((resolve) => {
          if (window.GoogleGenerativeAI) {
            resolve();
          } else {
            const checkGemini = setInterval(() => {
              if (window.GoogleGenerativeAI) {
                clearInterval(checkGemini);
                resolve();
              }
            }, 100);
          }
        });
      }

      // Cohere API configuration
      const COHERE_API_KEY = 'Tqvqv3zd5H3K8MaeMlqHeeLUjjhIPunt2384akbx';
      const COHERE_API_URL = 'https://api.cohere.ai/v1/chat';

      // Function to handle API errors
      function handleAPIError(error) {
        console.error('API Error:', error);
        
        if (error.status === 401) {
          return "The API key is invalid. Please check your Cohere API key.";
        }
        
        if (error.status === 429) {
          return "I'm currently getting too many requests. Please wait a minute and try again. If this continues, you may need to check your API quota.";
        }
        
        return "I'm having trouble connecting to the AI service right now. " + 
               (error.message ? `Error: ${error.message}` : 'Please try again in a moment.');
      }
      
      // Function to send message to Cohere API
      async function sendToAI(message) {
        try {
          // Get conversation history
          const messages = Array.from(document.querySelectorAll('.message'));
          let chatHistory = [];
          let systemMessage = 'You are a helpful assistant that helps create and improve survey questions. Provide clear, concise, and actionable feedback.';
          
          // Add previous messages to chat history
          messages.forEach(msg => {
            const isUser = msg.classList.contains('user');
            const role = isUser ? 'USER' : 'CHATBOT';
            const content = msg.textContent.trim();
            
            if (content) {
              chatHistory.push({
                role: role,
                message: content
              });
            }
          });
          
          // Prepare the request body
          const requestBody = {
            model: 'command-r-plus',
            message: message,
            chat_history: chatHistory,
            temperature: 0.7,
            max_tokens: 1000,
            preamble: systemMessage
          };
          
          // Call Cohere API directly
          const response = await fetch(COHERE_API_URL, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${COHERE_API_KEY}`,
              'Accept': 'application/json'
            },
            body: JSON.stringify(requestBody)
          });
          
          if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.message || 'Failed to get response from Cohere API');
          }
          
          const data = await response.json();
          return data.text;
          
        } catch (error) {
          console.error('Error calling Cohere API:', error);
          return handleAPIError(error);
        }
      }
      
      // Function to handle sending a message
      async function sendMessage() {
        const message = chatbotInput.value.trim();
        if (!message) return;
        
        // Add user message to chat
        addMessage(message, true);
        chatbotInput.value = '';
        
        // Show typing indicator
        showTypingIndicator();
        
        try {
          // Get response from AI
          const response = await sendToAI(message);
          
          // Remove typing indicator and add response
          hideTypingIndicator();
          addMessage(response, false);
        } catch (error) {
          console.error('Error:', error);
          hideTypingIndicator();
          addMessage("I'm sorry, I encountered an error. Please try again.", false);
        }
      }
      
      // Initialize Lucide icons for the chatbot
      lucide.createIcons();
    });
    
    // Add this to your existing script section that handles survey creation
    document.addEventListener('DOMContentLoaded', function() {
      // ... existing code ...
      
      // Add AI suggestion button to question cards
      function addAISuggestionButton(questionCard) {
        const aiButton = document.createElement('button');
        aiButton.className = 'flex items-center gap-1 text-xs text-indigo-600 hover:text-indigo-800 transition-colors';
        aiButton.innerHTML = '<i data-lucide="sparkles" class="w-3.5 h-3.5"></i> AI Suggestions';
        
        aiButton.addEventListener('click', async function() {
          const questionText = questionCard.querySelector('input[placeholder="Enter your question"]').value;
          
          if (!questionText) {
            alert('Please enter a question first to get AI suggestions.');
            return;
          }
          
          // Show the chatbot panel if not already open
          const chatbotPanel = document.getElementById('aiChatbotPanel');
          if (!chatbotPanel.classList.contains('active')) {
            chatbotPanel.classList.add('active');
          }
          
          // Focus the input and set the question
          const chatbotInput = document.getElementById('aiChatbotInput');
          chatbotInput.value = `Can you suggest improvements for this survey question: "${questionText}"`;
          chatbotInput.focus();
          
          // Trigger the send message
          document.getElementById('aiChatbotSend').click();
        });
        
        // Add the button to the question card actions
        const questionActions = questionCard.querySelector('.question-actions');
        if (questionActions) {
          questionActions.appendChild(aiButton);
        }
      }
      
      // Update the addQuestion function to include the AI suggestion button
      const originalAddQuestion = window.addQuestion || function() {};
      window.addQuestion = function(type) {
        const questionId = originalAddQuestion(type);
        const questionCard = document.querySelector(`[data-question-id="${questionId}"]`);
        if (questionCard) {
          addAISuggestionButton(questionCard);
        }
        return questionId;
      };
      
      // Add AI button to existing questions on page load
      document.querySelectorAll('.question-card-pro').forEach(questionCard => {
        addAISuggestionButton(questionCard);
      });
    });
  </script>
</body>
</html>
